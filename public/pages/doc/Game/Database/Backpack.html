<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Game::Database::Backpack
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!Game/Database/Backpack.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (B)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Game.html" title="Game (module)">Game</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Database.html" title="Game::Database (module)">Database</a></span></span>
     &raquo; 
    <span class="title">Backpack</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Game::Database::Backpack
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Game::Database::Backpack</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Neo4j::ActiveNode</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">rb/db/objects/backpack.rb<span class="defines">,<br />
  rb/db/objects/item.rb,<br /> rb/db/relations/backpack_items.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Clase que representa el inventario o mochila de un usuario.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_backpack-class_method" title="create_backpack (class method)">+ (Game::Mechanics::Backpack) <strong>create_backpack</strong>(level) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Crear un inventario para un usuario.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_item-instance_method" title="#add_item (instance method)">- (Hash) <strong>add_item</strong>(item, amount) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Añadir objetos de un tipo al inventario.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#exchange_stack_amount-instance_method" title="#exchange_stack_amount (instance method)">- (Hash) <strong>exchange_stack_amount</strong>(stack_id, amount) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Borra una cantidad de un stack de objetos.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fits%3F-instance_method" title="#fits? (instance method)">- (Boolean) <strong>fits?</strong>(item, amount) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Comprobar si un objeto cabe en la mochila.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_stack-instance_method" title="#get_stack (instance method)">- (Game::Database::RelationShips::BackpackItemStacks) <strong>get_stack</strong>(stack_id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Getter de un stack dado su identificador.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#has%3F-instance_method" title="#has? (instance method)">- (Boolean) <strong>has?</strong>(item, amount) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Comprobar si el inventario tiene una cantidad de un objeto.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#last_stack_id-instance_method" title="#last_stack_id (instance method)">- (Integer) <strong>last_stack_id</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Contador de stacks.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#recalculate_slots-instance_method" title="#recalculate_slots (instance method)">- (Object) <strong>recalculate_slots</strong>(new_level = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Recalcular espacio de la mochila.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_item_amount-instance_method" title="#remove_item_amount (instance method)">- (Object) <strong>remove_item_amount</strong>(item, amount) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Eliminar una cantidad de objetos.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#slots-instance_method" title="#slots (instance method)">- (Integer) <strong>slots</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Casillas del inventario.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#split_stack-instance_method" title="#split_stack (instance method)">- (Hash) <strong>split_stack</strong>(stack_id, restack_amount, target_stack_id = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Particionar una pila de objetos.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stacks-instance_method" title="#stacks (instance method)">- (Game::Database::Item) <strong>stacks</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Relación de la mochila de cada uno de los usuarios con los objetos,
formando stacks.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_hash-instance_method" title="#to_hash (instance method)">- (Hash&lt;Symbol, Object&gt;) <strong>to_hash</strong>(exclusion_list = []) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Transformar objeto a un hash.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#user-instance_method" title="#user (instance method)">- (Game::Database::User) <strong>user</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Relación con el usuario que posee el inventario (#Game::Database::User).</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="create_backpack-class_method">
  
    + (<tt>Game::Mechanics::Backpack</tt>) <strong>create_backpack</strong>(level) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Crear un inventario para un usuario.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>level</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Nivel del usuario para crear los slots del inventario.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Game::Mechanics::Backpack</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Objeto creado (no enlazado a un usuario).</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 50</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_backpack'>create_backpack</span><span class='lparen'>(</span> <span class='id identifier rubyid_level'>level</span> <span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span> <span class='label'>slots:</span> <span class='const'>Game</span><span class='op'>::</span><span class='const'>Mechanics</span><span class='op'>::</span><span class='const'>BackpackMechanics</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span><span class='lparen'>(</span><span class='id identifier rubyid_level'>level</span><span class='rparen'>)</span> <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_item-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>) <strong>add_item</strong>(item, amount) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Añadir objetos de un tipo al inventario.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Tipo de objeto a añadir.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>amount</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Cantidad a añadir.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Propiedades de la adición.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">GenericException</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Si algo falla estrepitosamente, genera una excepción.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 90</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_item'>add_item</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>
  
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid item.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_item'>item</span> <span class='op'>==</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid amount.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Amount is too big for one stack.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_max_amount'>max_amount</span>
  
  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>added_amount:</span> <span class='int'>0</span><span class='comma'>,</span>
    <span class='label'>desired_add_amout:</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span>
    <span class='label'>info:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>

  <span class='comment'># Operación atómica.
</span>  <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>DatabaseManager</span><span class='period'>.</span><span class='id identifier rubyid_run_nested_transaction'>run_nested_transaction</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tx'>tx</span><span class='op'>|</span>
    <span class='comment'># Comprobar si se puede añadir a un stack existente, y añadir la cantidad que se pueda a cada uno
</span>    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_match_to'>match_to</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each_with_rel'>each_with_rel</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_it'>it</span><span class='comma'>,</span> <span class='id identifier rubyid_rel'>rel</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_empty_space'>empty_space</span> <span class='op'>=</span> <span class='id identifier rubyid_rel'>rel</span><span class='period'>.</span><span class='id identifier rubyid_empty_space'>empty_space</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>&gt;=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_add_amount'>add_amount</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_empty_space'>empty_space</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>

        <span class='id identifier rubyid_rel'>rel</span><span class='period'>.</span><span class='id identifier rubyid_force_add_item'>force_add_item</span><span class='lparen'>(</span> <span class='id identifier rubyid_add_amount'>add_amount</span> <span class='rparen'>)</span>
        <span class='id identifier rubyid_amount'>amount</span> <span class='op'>-=</span> <span class='id identifier rubyid_add_amount'>add_amount</span>
        <span class='id identifier rubyid_output'>output</span><span class='lbracket'>[</span><span class='symbol'>:added_amount</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_add_amount'>add_amount</span>
      <span class='kw'>end</span>

      <span class='kw'>break</span> <span class='kw'>if</span> <span class='lparen'>(</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span> <span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='comment'># Si aún queda cantidad, se añade otro stack
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='comment'># En otro caso, se añadirña otro stack. Se comprueba si queda espacio para añadir un nuevo stack.
</span>      <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span>
        <span class='id identifier rubyid_output'>output</span><span class='lbracket'>[</span><span class='symbol'>:info</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Could not add all items: backpack is full.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='comment'># Finalmente, se añade el/los nuevo/s stack/s.
</span>        <span class='id identifier rubyid_output'>output</span><span class='lbracket'>[</span><span class='symbol'>:added_amount</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_amount'>amount</span>

        <span class='id identifier rubyid_force_add_item'>force_add_item</span><span class='lparen'>(</span> <span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span> <span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="exchange_stack_amount-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>) <strong>exchange_stack_amount</strong>(stack_id, amount) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Borra una cantidad de un stack de objetos.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>stack_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Identificador del stack.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Información del proceso de borrado.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">::GenericException</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 170</span>

<span class='kw'>def</span> <span class='id identifier rubyid_exchange_stack_amount'>exchange_stack_amount</span><span class='lparen'>(</span><span class='id identifier rubyid_stack_id'>stack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid stack id.</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_stack_id'>stack_id</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&lt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid amount (null).</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&lt;=</span> <span class='int'>0</span>

  <span class='id identifier rubyid_count'>count</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>DatabaseManager</span><span class='period'>.</span><span class='id identifier rubyid_run_nested_transaction'>run_nested_transaction</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tx'>tx</span><span class='op'>|</span>
    <span class='id identifier rubyid_stack'>stack</span> <span class='op'>=</span> <span class='id identifier rubyid_get_stack'>get_stack</span><span class='lparen'>(</span><span class='id identifier rubyid_stack_id'>stack_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_item'>item</span> <span class='op'>=</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span>

    <span class='comment'># item = stack.to_node
</span>    <span class='id identifier rubyid_count'>count</span> <span class='op'>=</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_remove_amount'>remove_amount</span><span class='lparen'>(</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='rparen'>)</span>

    <span class='comment'># Cambiar el contenido borrado por energía.
</span>    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_add_energy'>add_energy</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_energy_value'>energy_value</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='id identifier rubyid_count'>count</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>
  
  <span class='kw'>return</span> <span class='lbrace'>{</span>
    <span class='label'>removed:</span> <span class='id identifier rubyid_count'>count</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fits?-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Boolean.html" title="Boolean (module)">Boolean</a></span></tt>) <strong>fits?</strong>(item, amount) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Comprobar si un objeto cabe en la mochila.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Referencia al objeto.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>amount</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Cantidad a comprobar si caben.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Boolean.html" title="Boolean (module)">Boolean</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>True si cabe. False en caso contrario.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 248</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fits?'>fits?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid item.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_item'>item</span> <span class='op'>==</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid amount.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Amount is too big for one stack.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_max_amount'>max_amount</span>

  <span class='comment'># Stacks de sobra?
</span>  <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&lt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span>

  <span class='comment'># Espacio en algún stack?
</span>  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_match_to'>match_to</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each_rel'>each_rel</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_fits?'>fits?</span> <span class='id identifier rubyid_amount'>amount</span>
      <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_stack-instance_method">
  
    - (<tt><span class='object_link'><a href="RelationShips/BackpackItemStacks.html" title="Game::Database::RelationShips::BackpackItemStacks (class)">Game::Database::RelationShips::BackpackItemStacks</a></span></tt>) <strong>get_stack</strong>(stack_id) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Getter de un stack dado su identificador.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>stack_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Identificador del stack (numérico).</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="RelationShips/BackpackItemStacks.html" title="Game::Database::RelationShips::BackpackItemStacks (class)">Game::Database::RelationShips::BackpackItemStacks</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Stack o relación del nodo.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">::GenericException</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162
163
164
165</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 160</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_stack'>get_stack</span><span class='lparen'>(</span><span class='id identifier rubyid_stack_id'>stack_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_stack'>stack</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='lparen'>(</span><span class='symbol'>:s</span><span class='comma'>,</span> <span class='symbol'>:r</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r.stack_id = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_stack_id'>stack_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_pluck'>pluck</span><span class='lparen'>(</span><span class='symbol'>:r</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stack not found.</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_stack'>stack</span> <span class='op'>==</span> <span class='kw'>nil</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_stack'>stack</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="has?-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Boolean.html" title="Boolean (module)">Boolean</a></span></tt>) <strong>has?</strong>(item, amount) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Comprobar si el inventario tiene una cantidad de un objeto.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Referencia al objeto.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>amount</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Cantidad a comprobar si existen.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Boolean.html" title="Boolean (module)">Boolean</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>True si existe la cantidad. False en caso contrario.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 272</span>

<span class='kw'>def</span> <span class='id identifier rubyid_has?'>has?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid item.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_item'>item</span> <span class='op'>==</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid amount.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Amount is too big for one stack.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_max_amount'>max_amount</span>

  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_match_to'>match_to</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each_rel'>each_rel</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_has?'>has?</span> <span class='id identifier rubyid_amount'>amount</span>
      <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>


  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="last_stack_id-instance_method">
  
    - (<tt>Integer</tt>) <strong>last_stack_id</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Contador de stacks.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Contador de stacks.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 27</span>

<span class='id identifier rubyid_property'>property</span> <span class='symbol'>:last_stack_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="recalculate_slots-instance_method">
  
    - (<tt>Object</tt>) <strong>recalculate_slots</strong>(new_level = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Recalcular espacio de la mochila.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>new_level</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Nuevo nivel. Si es nil, se cogerá el nivel actual del usuario.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">::GenericException</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 60</span>

<span class='kw'>def</span> <span class='id identifier rubyid_recalculate_slots'>recalculate_slots</span><span class='lparen'>(</span> <span class='id identifier rubyid_new_level'>new_level</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_new_level'>new_level</span> <span class='op'>=</span> <span class='id identifier rubyid_new_level'>new_level</span> <span class='op'>||</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_level_profile'>level_profile</span><span class='period'>.</span><span class='id identifier rubyid_level'>level</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='label'>slots:</span> <span class='const'>Game</span><span class='op'>::</span><span class='const'>Mechanics</span><span class='op'>::</span><span class='const'>BackpackMechanics</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span><span class='lparen'>(</span> <span class='id identifier rubyid_new_level'>new_level</span> <span class='rparen'>)</span> <span class='rparen'>)</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid slots recalculation: too small.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span>
  
  <span class='kw'>return</span> <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_item_amount-instance_method">
  
    - (<tt>Object</tt>) <strong>remove_item_amount</strong>(item, amount) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Eliminar una cantidad de objetos.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Objeto a borrar.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>amount</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Cantidad de objetos a borrar.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">GenericException</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>En caso de no poder borrar, generará una excepción.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 138</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_item_amount'>remove_item_amount</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid item.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_item'>item</span> <span class='op'>==</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid amount.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Amount is too big for one stack.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_max_amount'>max_amount</span>

  <span class='comment'># Comprobar que el usuario tengo espacio para el objeto.
</span>  <span class='id identifier rubyid_correct'>correct</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_match_to'>match_to</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each_rel'>each_rel</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_has?'>has?</span> <span class='id identifier rubyid_amount'>amount</span>
      <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_remove_amount'>remove_amount</span><span class='lparen'>(</span> <span class='id identifier rubyid_amount'>amount</span>  <span class='rparen'>)</span>
      <span class='id identifier rubyid_correct'>correct</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User does not own </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> of </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_correct'>correct</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="slots-instance_method">
  
    - (<tt>Integer</tt>) <strong>slots</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Casillas del inventario.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Tamaño del inventario (slots).</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


23</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 23</span>

<span class='id identifier rubyid_property'>property</span> <span class='symbol'>:slots</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="split_stack-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>) <strong>split_stack</strong>(stack_id, restack_amount, target_stack_id = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Particionar una pila de objetos.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>stack_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Identificador del stack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>restack_amount</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Cantidad a añadir al nuevo stack, eliminándolo del viejo.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>target_stack_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Nuevo stack sobre el que apilar los objetos. Si es nil, se apilará sobre un
hueco vacío.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Información de la partición.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../GenericException.html" title="GenericException (class)">::GenericException</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 196</span>

<span class='kw'>def</span> <span class='id identifier rubyid_split_stack'>split_stack</span><span class='lparen'>(</span><span class='id identifier rubyid_stack_id'>stack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span><span class='comma'>,</span> <span class='id identifier rubyid_target_stack_id'>target_stack_id</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Comprobar si queda espacio para partir un stack.
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>There is no free space to split a stack.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_target_stack_id'>target_stack_id</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>&amp;&amp;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_slots'>slots</span>

  <span class='id identifier rubyid_stack'>stack</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_new_stack'>new_stack</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='comment'># Operación atómica.
</span>  <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>DatabaseManager</span><span class='period'>.</span><span class='id identifier rubyid_run_nested_transaction'>run_nested_transaction</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tx'>tx</span><span class='op'>|</span>
    <span class='comment'># Buscar el stack a partir del identificador
</span>    <span class='id identifier rubyid_stack'>stack</span> <span class='op'>=</span> <span class='id identifier rubyid_get_stack'>get_stack</span><span class='lparen'>(</span><span class='id identifier rubyid_stack_id'>stack_id</span><span class='rparen'>)</span>

    <span class='comment'># Comprobar que hay cantidad suficiente para particionar
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid restack amount</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='op'>&lt;=</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>

    <span class='comment'># Realizar la partición
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_target_stack_id'>target_stack_id</span> <span class='op'>==</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='label'>amount:</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span> <span class='op'>-</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='rparen'>)</span>
      <span class='id identifier rubyid_new_stack'>new_stack</span> <span class='op'>=</span> <span class='id identifier rubyid_force_add_item'>force_add_item</span><span class='lparen'>(</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_stack_to'>stack_to</span> <span class='op'>=</span> <span class='id identifier rubyid_get_stack'>get_stack</span><span class='lparen'>(</span><span class='id identifier rubyid_target_stack_id'>target_stack_id</span><span class='rparen'>)</span>

      <span class='comment'># Comprobar que el objeto es compatible.
</span>      <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Incompatible stacks (</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_stack_id'>stack_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> - </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_item_id'>item_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>) and (</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_new_stack'>new_stack</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> - </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_stack_to'>stack_to</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_item_id'>item_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>).</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_stack_to'>stack_to</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_item_id'>item_id</span> <span class='op'>!=</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_item_id'>item_id</span>

      <span class='comment'># Comprobar que hay espacio.
</span>      <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'>GenericException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Target stack is too big to fit the resources.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_stack_to'>stack_to</span><span class='period'>.</span><span class='id identifier rubyid_fits?'>fits?</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span>

       <span class='comment'># Realizar cambios
</span>      <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='label'>amount:</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span> <span class='op'>-</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='rparen'>)</span>
      <span class='id identifier rubyid_stack_to'>stack_to</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='label'>amount:</span> <span class='id identifier rubyid_stack_to'>stack_to</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span> <span class='op'>+</span> <span class='id identifier rubyid_restack_amount'>restack_amount</span> <span class='rparen'>)</span>

      <span class='id identifier rubyid_new_stack'>new_stack</span> <span class='op'>=</span> <span class='id identifier rubyid_stack_to'>stack_to</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Preparar la salida.
</span>  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>old_stack:</span> <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='comma'>,</span>
    <span class='label'>new_stack:</span> <span class='id identifier rubyid_new_stack'>new_stack</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span>
  <span class='rbrace'>}</span>

  <span class='comment'># Si el el viejo stack quedan 0 recursos, eliminarlo
</span>  <span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_remove_if_empty'>remove_if_empty</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stacks-instance_method">
  
    - (<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>) <strong>stacks</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Relación de la mochila de cada uno de los usuarios con los objetos,
formando stacks. Se puede acceder con el atributo
<code>backpack_owners</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Item.html" title="Game::Database::Item (class)">Game::Database::Item</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Objeto del stack.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 41</span>

<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:out</span><span class='comma'>,</span> <span class='symbol'>:stacks</span><span class='comma'>,</span> <span class='label'>rel_class:</span> <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>RelationShips</span><span class='op'>::</span><span class='const'>BackpackItemStacks</span><span class='comma'>,</span> <span class='label'>model_class:</span> <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>Item</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_hash-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span>&lt;Symbol, Object&gt;</tt>) <strong>to_hash</strong>(exclusion_list = []) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Transformar objeto a un hash</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>exclusion_list</span>
      
      
        <span class='type'>(<tt>Array&lt;Symbol&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Elementos a omitir en el hash de resultado (…).</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span>&lt;Symbol, Object&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Objeto como hash.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


292
293
294
295
296
297
298
299
300
301
302
303
304
305
306</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 292</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_exclusion_list'>exclusion_list</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='int'>0</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stacks'>stacks</span><span class='period'>.</span><span class='id identifier rubyid_each_with_rel'>each_with_rel</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_rel'>rel</span><span class='op'>|</span>
    <span class='id identifier rubyid_output'>output</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span>
      <span class='label'>item_id:</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_item_id'>item_id</span><span class='comma'>,</span>
      <span class='label'>stack:</span> <span class='id identifier rubyid_rel'>rel</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span>
    <span class='rbrace'>}</span>
    
    <span class='id identifier rubyid_index'>index</span> <span class='op'>+=</span> <span class='int'>1</span>
  <span class='kw'>end</span>
  
  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="user-instance_method">
  
    - (<tt><span class='object_link'><a href="User.html" title="Game::Database::User (class)">Game::Database::User</a></span></tt>) <strong>user</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Relación con el usuario que posee el inventario (#Game::Database::User). Se
puede acceder con el atributo <code>user</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="User.html" title="Game::Database::User (class)">Game::Database::User</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Usuario.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rb/db/objects/backpack.rb', line 36</span>

<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:in</span><span class='comma'>,</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='label'>model_class:</span> <span class='const'>Game</span><span class='op'>::</span><span class='const'>Database</span><span class='op'>::</span><span class='const'>User</span><span class='comma'>,</span> <span class='label'>origin:</span> <span class='symbol'>:backpack</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri May 22 14:15:08 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.0).
</div>

  </body>
</html>