
task :default => ["development:start"]

# --------------------------------------------------------------

namespace :setup do
  desc 'Setup everything.'
  task :bundle do
    # Install bundle
    begin
      sh 'gem install bundle'
    rescue
      puts "Error while installing bundle."
    end

    # Install gems
    begin
      sh 'bundle install'
    rescue
      puts "Error while installing gems."
    end

    puts "Use '$ rake' to start with development!"
  end

  desc 'Update gems.'
  task :update do
    begin
      sh 'bundle update'
    rescue
      puts "Error while installing update."
    end
  end
end

desc 'Default setup task'
task :setup do Rake::Task['setup:bundle'].execute end

# --------------------------------------------------------------

#  ----------- TEST MUST NEVER BE RUN IN PRODUCTION MODE -----------
begin 
  require 'rake/testtask'
  namespace :test do
    task :unit => :development do
      ruby 'test/unit/all.rb'
    end
  end

  desc 'Default test task. TEST MUST NEVER BE RUN IN PRODUCTION MODE'
  task :test do Rake::Task['test:unit'].execute end
rescue Exception => e
  puts " ** TEST ERROR ** " + e.message
end


# --------------------------------------------------------------

begin
  require 'yard'
  namespace :doc do
    YARD::Rake::YardocTask.new(:generate) do |t|
      t.files   = [ 'rb/**/*.rb', 'main.rb' ]
      t.options = ['-opublic/pages/doc', '--no-stats']
      
      t.after = Proc.new {
        Rake::Task['doc:stats'].execute
      }
    end
    
    desc "Shows stats for YARD Documentation including listing undocumented modules, classes, constants, and methods"
    task :stats do
      stats = YARD::CLI::Stats.new
      stats.files   = [ 'rb/**/*.rb', 'main.rb' ]
      stats.run('main.rb', 'rb/**/*.rb', '--list-undoc')
    end
  end

  desc 'Default doc task'
  task :doc do Rake::Task['doc:generate'].execute end
rescue Exception => e
  puts " ** YARD ERROR ** " + e.message
end

# --------------------------------------------------------------

namespace :neo4j do
  desc 'Start the Neo4j Server'
  task :start do
    sh 'neo4j start'
  end

  desc 'Stop the Neo4j Server'
  task :stop do
    sh 'neo4j stop'
  end
end

desc 'Default neo4j task'
task :neo4j do Rake::Task['neo4j:start'].execute end

# --------------------------------------------------------------

namespace :development do
  desc 'Quick dev start'
  task :start do
    begin
      sh 'neo4j start'
    rescue
    end
    sh 'rackup'
  end

  desc 'Start a racksh console for console debuggin.'
  task :sh do
    begin
      sh 'neo4j start'
    rescue
    end
    sh 'racksh'
  end
end

desc 'Default development task'
task :development do Rake::Task['development:start'].execute end

# --------------------------------------------------------------

namespace :production do
  desc 'Start the server'
  task :start do
    sh 'bundle exec rackup -E production'
  end

  desc 'Start the server (network test)'
  task :start_net do
    sh 'ruby main.rb -o 0.0.0.0' # Â¿?
  end
end

desc 'Default production task'
task :production do Rake::Task['production:start'].execute end

# --------------------------------------------------------------

namespace :heroku do
  desc 'Setup heroku toolbelt.'
  task :setup do
    sh "wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh"
  end

  desc 'Launch the server to an heroku app.'
  task :start do
    sh 'git push heroku HEAD:master --force'
  end

  desc 'Log heroku data and errors.'
  task :logs do
    sh 'heroku logs'
  end

end

desc 'Default heroku task'
task :heroku do Rake::Task['heroku:start'].execute end

# --------------------------------------------------------------

namespace :docker do
  desc 'Setup all.'
  task :setup do
    Rake::Task['docker:neo4j:setup'].execute
    # OSRM
    Rake::Task['docker:progrezz:setup'].execute
  end
  
  desc 'Unsetup all.'
  task :unsetup do
    Rake::Task['docker:neo4j:unsetup'].execute
    # OSRM
    Rake::Task['docker:progrezz:unsetup'].execute
  end
  
  desc 'Start all.'
  task :start do
    Rake::Task['docker:neo4j:start'].execute
    # OSRM
    sleep(5); Rake::Task['docker:progrezz:start'].execute
  end
  
  desc 'Stop all.'
  task :stop do
    Rake::Task['docker:progrezz:stop'].execute
    Rake::Task['docker:neo4j:stop'].execute
    # OSRM
  end

  
  namespace :progrezz do
    desc 'Setup progrezz docker image.'
    task :setup do
      Rake::Task['docker:progrezz:build'].execute
      sh "docker create -i -t --name=progrezz_server --link neo4j:neo4j progrezz/server" #  -d
    end
    
    desc 'Setup progrezz docker image (unlinked to other containers).'
    task :setup_unlinked do
      Rake::Task['docker:progrezz:build'].execute
      sh "docker create -i -t --name=progrezz_server progrezz/server" #  -d
    end
    
    desc 'Unsetup progrezz docker image.'
    task :unsetup do
      sh "docker rm progrezz_server"
      sh "docker rmi progrezz/server"
    end
      
    desc 'Build (or rebuild) progrezz docker image.'
    task :build do
      sh "docker build -t progrezz/server ."
    end

    desc 'Start progrezz docker process (linked to a neo4j container).'
    task :start, [:rake_task] do |t, args|
      sh 'docker start -a -i progrezz_server' + args[:rake_task].to_s
    end
    
     desc 'Start progrezz docker process in the background.'
    task :start, [:rake_task] do |t, args|
      sh 'docker start progrezz_server' + args[:rake_task].to_s
    end
    
    desc 'Stop progrezz docker process.'
    task :stop do
      sh 'docker stop progrezz_server'
    end
  end
  
  desc 'Default progrezz docker task'
  task :progrezz do Rake::Task['docker:progrezz:start'].execute end
  
  namespace :neo4j do
    desc 'Setup neo4j docker image.'
    task :setup do
      sh "docker create  -i -t --name neo4j tpires/neo4j" #  -d
    end
    
    desc 'Unsetup neo4j docker image.'
    task :setup do
      sh "docker rm neo4j"
      sh "docker rmi tpires/neo4j"
    end
    
    desc 'Start the neo4j embedded server.'
    task :start do
      sh "docker start neo4j"
    end
    
    desc 'Stop the neo4j embded server.'
    task :stop do
      sh "docker stop neo4j"
    end
  end
  
  desc 'Default neo4j docker task'
  task :neo4j do Rake::Task['docker:neo4j:start'].execute end
end

desc 'Default docker task'
task :docker do Rake::Task['docker:progrezz'].execute end

